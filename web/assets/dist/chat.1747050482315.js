var T=Object.defineProperty;var q=Object.getOwnPropertyDescriptor;var B=Object.getOwnPropertyNames;var J=Object.prototype.hasOwnProperty;var R=(t,e)=>{for(var n in e)T(t,n,{get:e[n],enumerable:!0})},D=(t,e,n,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of B(e))!J.call(t,s)&&s!==n&&T(t,s,{get:()=>e[s],enumerable:!(r=q(e,s))||r.enumerable});return t};var P=t=>D(T({},"__esModule",{value:!0}),t);var G={};R(G,{default:()=>z});module.exports=P(G);var _="sc",E="id",j="template-id",W="type",O="method",K="form-onerror",X="form-onsuccess",Y="handler",c={formMethods:new Map,elements:new Map,handlers:new Map,state:new Map,getByType(t){let e=[];return this.elements.forEach(n=>{n.type===t&&e.push(n)}),e}},m=t=>`data-${_}-${t}`,k=t=>Array.from(t.querySelectorAll(`[${m(E)}]`)),v=t=>{let e=t.getAttribute(m(E));if(!e)throw new Error(`${v.name}: id is required`);if(c.elements.get(e))throw new Error(`${v.name}: id ${e} already exists`);c.elements.set(e,new S(t))},$=()=>{for(let t of c.handlers.keys())c.elements.forEach(e=>{if(e.handleName===t&&!e.isHandleApplied&&e.handleEvent){let n=c.handlers.get(t);if(!n)throw new Error(`${$.name}: handler ${t} not found`);let r=s=>{n(s,e,c)};e.ref.addEventListener(e.handleEvent,r),e.handlers.push(r),e.isHandleApplied=!0}})},N={get(t){return c.state.get(t)},set(t,e){c.state.set(t,e)}},S=class t{id;type=null;handleName=null;handleEvent=null;isHandleApplied=!1;isTemplate=!1;ref;templateWrapperRef=null;handlers;constructor(e){let n=e.getAttribute(m(E));if(!n)throw new Error(`${t.name}: id is required`);let r=e.getAttribute(m(W));r&&(this.type=r);let s=e.getAttribute(`${m(Y)}`);if(this.id=n,this.ref=e,this.handlers=[],s){let o=s.split(":");o[0]&&o[1]&&(this.handleEvent=o[0],this.handleName=o[1])}let i=this.ref.getAttribute(`${m(O)}`)&&this.ref.getAttribute("action");this.ref instanceof HTMLFormElement&&i?this.overrideSubmit(this.ref):this.ref instanceof HTMLTemplateElement&&(this.isTemplate=!0)}overrideSubmit=e=>{let n=async r=>{r.preventDefault();let s=e.getAttribute("action"),i=e.getAttribute(`${m(O)}`),o=e.getAttribute(`${m(X)}`),l=e.getAttribute(`${m(K)}`);if(!i||!s){console.warn(`${this.overrideSubmit.name}: action or method is missing, skipping`);return}let h=["POST","PUT","DELETE","PATCH"],d=i.toUpperCase();if(!h.includes(d)){console.warn(`${this.overrideSubmit.name}: method ${i} is not supported, skipping`);return}let u={};for(let a of e.querySelectorAll("[name]"))if(a instanceof HTMLInputElement){if(!isNaN(Number(a.value))){if(Number.isInteger(a.value)){u[a.name]=parseInt(a.value);continue}u[a.name]=parseFloat(a.value);continue}u[a.name]=a.value}try{let a=await fetch(s,{method:d,body:JSON.stringify(u),credentials:"include",headers:{"Content-Type":"application/json"}});if(!a.ok){let p=await a.text();if(!l){console.error("error: "+p);return}let g=c.formMethods.get(l);if(!g)return;g(p);return}if(o){let g=a.headers.get("content-type")?.includes("application/json")?await a.json():null,x=c.formMethods.get(o);if(!x)throw new Error(`${this.overrideSubmit.name}: success handler ${o} not found`);x(g)}}catch(a){console.error(a.message)}};e.addEventListener("submit",n),this.handlers.push(n)};insertTemplateInto=(e,n)=>{let r=e instanceof t?e.ref:e;if(!this.isTemplate)throw new Error(`${this.insertTemplateInto.name}: element is not a template`);if(!r)throw new Error(`${this.insertTemplateInto.name}: target is required`);let s=document.createElement("div"),o=this.ref.content.cloneNode(!0);s.appendChild(o),s.setAttribute(m(j),this.id),n&&n.classNames&&n.classNames.forEach(l=>{s.classList.add(l)}),this.templateWrapperRef=s,n&&n.clearBeforeInsert&&(b(r),r.innerHTML=""),r.appendChild(s),M(s),$()};remove(){let e=this.isTemplate?this.templateWrapperRef:this.ref;e&&(this.handlers.forEach(n=>{this.handleEvent&&e.removeEventListener(this.handleEvent,n)}),b(e),e.remove())}},M=t=>{k(t).forEach(n=>{v(n)})},b=t=>{k(t).forEach(n=>{let r=n.getAttribute(m(E));if(!r)throw new Error(`${b.name}: id is not found, you somehow added a non custom element into the store`);let s=c.elements.get(r);s&&(s.handlers.forEach(i=>{s.handleEvent&&s.ref.removeEventListener(s.handleEvent,i)}),s.ref.remove()),c.elements.delete(r)})},I=t=>t instanceof HTMLTemplateElement,f=t=>{let e=c.elements.get(t);return e||null},w=(t,e)=>{if(c.handlers.get(t))throw new Error(`${w.name}: handler ${t} already exists`);c.handlers.set(t,e),$()},y=(t,e)=>{if(c.formMethods.get(t))throw new Error(`${y.name}: method ${t} already exists`);c.formMethods.set(t,e)};var H=()=>{let t;return{connect(e,{onClose:n,onError:r,onOpen:s,onMessage:i}){t=new WebSocket(`${e}/ws`),t.onopen=o=>{s&&s(o)},t.onmessage=o=>{i&&i(o)},t.onclose=o=>{n&&n(o)},t.onerror=o=>{r&&r(o)}},disconnect(){t&&t.close()},send:e=>{t&&t.send(e)}}};var{get:A,set:L}=N,C=H();M(document.body);w("openChat",(t,e,n)=>{n.getByType("chat-button").forEach(d=>{d.ref.classList.remove("active")}),t.currentTarget.classList.add("active");let i=n.elements.get("chatBody");if(!i)throw new Error("chatBody not found");let o=n.elements.get("chatTemplate");if(!o)throw new Error("chatTemplate not found");o.insertTemplateInto(i,{clearBeforeInsert:!0});let l=e.id.split("_")[1];if(L("toUuid",l),!l)throw new Error("toUuid not found");let h=sessionStorage.getItem(l);if(h){let d=f("messages");if(!d)throw new Error("messages not found");JSON.parse(h).forEach(u=>{let a=u.fromUuid===A("myUuid");F(u,d.ref,a)})}});w("handleInput",t=>{let e=t,n=A("toUuid"),r=e.currentTarget;e.key==="Enter"&&e.shiftKey||e.key==="Enter"&&n&&r.value.trim().length>0&&(C.send(JSON.stringify({toUuid:n,msg:r.value.trim()})),r.value="")});y("inviteOnError",t=>{(f("inviteError")?.ref).innerText=t});y("inviteOnSuccess",()=>{location.reload()});var F=(t,e,n)=>{let r=f("messageTemplate");if(!r)throw new Error("messageTemplate not found");if(I(r.ref)){let i=r.ref.content.querySelector(".message-date"),o=r.ref.content.querySelector(".message-from"),l=r.ref.content.querySelector(".message-text");i.innerText=`${new Date(t.createdAt).toLocaleString("en-US",{month:"short",day:"numeric",hour:"numeric",minute:"numeric",second:"numeric",hour12:!1})}`,o.innerText=`${t.username}`,l.innerText=`${t.message}`}let s=n?["message","me"]:["message"];r.insertTemplateInto(e,{clearBeforeInsert:!1,classNames:s})},U=(t,e)=>{let n=sessionStorage.getItem(t);n?sessionStorage.setItem(t,JSON.stringify([...JSON.parse(n),e])):sessionStorage.setItem(t,JSON.stringify([e]))},z={connect(t,e){if(!e)throw new Error("myUuid not found");L("myUuid",e),C.connect(t,{onOpen(n){console.log(n,"event onopen")},onMessage(n){let r=JSON.parse(n.data),s;r.forEach(o=>{switch(o.event){case"isOnline":let l=JSON.parse(o.message);for(let g of l)s=f(`isOnline_${g}`),s&&(s.ref.textContent="Online");break;case"join":s=f(`isOnline_${o.fromUuid}`),s&&(s.ref.textContent="Online");break;case"quit":s=f(`isOnline_${o.fromUuid}`),s&&(s.ref.textContent="Offline");break;case"message":let h=A("toUuid"),d=f("messages"),u=o.fromUuid===e,a=o.username==="System"&&o.fromUuid===e,p=o.fromUuid===h||o.toUuid===h;if(o.username!=="System"&&p&&U(h,o),!d){U(o.fromUuid,o),console.warn("cant find messages");return}(p||a)&&F(o,d.ref,u);break}});let i=f("messages");i&&requestAnimationFrame(()=>{i.ref.parentElement?.scrollTo({top:i.ref.parentElement?.scrollHeight,behavior:"smooth"})})},onClose(n){console.log(n,"on close")},onError(n){console.error(n,"on error");let r=f("toast");if(!r)throw new Error("toast not found");let s=r.ref.content.querySelector("p");if(!s)throw new Error("toast p not found");s.innerText="Could not connect to server. Please try again later.",r.insertTemplateInto(document.body),setTimeout(()=>{r.remove()},2e3)}})}};
